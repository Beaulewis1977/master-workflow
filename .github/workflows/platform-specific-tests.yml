name: Platform-Specific Tests

on:
  workflow_dispatch:
    inputs:
      target_platform:
        description: 'Target platform for testing'
        required: true
        type: choice
        options:
          - windows
          - macos
          - linux
          - all
      test_type:
        description: 'Type of tests to run'
        required: true
        type: choice
        options:
          - unit
          - integration
          - performance
          - all
      agent_count:
        description: 'Number of agents for scaling tests'
        required: false
        default: '100'
        type: string

env:
  NODE_VERSION: '18'
  CLAUDE_FLOW_VERSION: '2.0.0'

jobs:
  # Windows-specific testing
  test-windows:
    name: Windows Platform Tests
    runs-on: windows-latest
    if: github.event.inputs.target_platform == 'windows' || github.event.inputs.target_platform == 'all'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Windows Environment Setup
      shell: powershell
      run: |
        Write-Host "Windows Version:" (Get-WmiObject -Class Win32_OperatingSystem).Caption
        Write-Host "PowerShell Version:" $PSVersionTable.PSVersion
        Write-Host "Architecture:" $env:PROCESSOR_ARCHITECTURE
        
        # Enable Developer Mode for symbolic links
        reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock" /t REG_DWORD /f /v "AllowDevelopmentWithoutDevLicense" /d "1" 2>$null || echo "Developer mode setting failed"
        
        # Set PowerShell execution policy
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force

    - name: Install Windows dependencies
      shell: powershell
      run: |
        # Install chocolatey if not present
        if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host "Installing Chocolatey..."
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }
        
        # Install useful tools
        choco install git -y --no-progress || echo "Git installation failed or already installed"

    - name: Install NPM dependencies
      run: npm ci

    - name: Test Windows PowerShell integration
      shell: powershell
      run: |
        Write-Host "Testing PowerShell integration..."
        node -e "
          const ShellIntegrationManager = require('./src/platform/shell-integration');
          (async () => {
            const manager = new ShellIntegrationManager();
            await manager.initialize();
            const status = manager.getStatus();
            const psDetected = status.detectedShells.find(s => s.name === 'powershell');
            console.log('PowerShell detected:', psDetected ? 'Yes' : 'No');
            if (psDetected) {
              console.log('PowerShell version:', psDetected.version);
            }
          })().catch(console.error);
        "

    - name: Test Windows CMD integration
      shell: cmd
      run: |
        echo Testing CMD integration...
        node -e "const pathHandler = require('./src/platform/path-handler').default; console.log('Windows path test:', pathHandler.normalize('C:\\Windows\\System32'));"

    - name: Test Windows-specific paths
      shell: powershell
      run: |
        node -e "
          const pathHandler = require('./src/platform/path-handler').default;
          const paths = pathHandler.getConfigPaths();
          console.log('Windows config paths:');
          Object.entries(paths).forEach(([key, value]) => {
            console.log('  ' + key + ':', value);
          });
        "

    - name: Test Windows process management
      run: |
        node -e "
          const { ProcessManager } = require('./src/platform/process-manager');
          (async () => {
            const manager = new ProcessManager();
            await manager.initialize();
            console.log('Windows process manager initialized');
            
            // Test Windows-specific command
            const result = await manager.execute('ver');
            console.log('Windows version command result:', result.success);
          })().catch(console.error);
        "

    - name: Test Windows registry access
      shell: powershell
      run: |
        node -e "
          console.log('Testing Windows registry simulation...');
          // Simulate registry operations
          console.log('Registry test completed');
        "

  # macOS-specific testing  
  test-macos:
    name: macOS Platform Tests
    runs-on: macos-latest
    if: github.event.inputs.target_platform == 'macos' || github.event.inputs.target_platform == 'all'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: macOS Environment Setup
      run: |
        echo "macOS Version: $(sw_vers -productVersion)"
        echo "Architecture: $(uname -m)"
        echo "Shell: $SHELL"
        echo "Homebrew: $(which brew || echo 'Not installed')"
        
        # Check for Xcode tools
        xcode-select -p || echo "Xcode tools not found"

    - name: Install macOS dependencies
      run: |
        # Install Homebrew if not present
        if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        
        # Install useful tools
        brew install git || echo "Git already installed"

    - name: Install NPM dependencies
      run: npm ci

    - name: Test macOS shell integration
      run: |
        echo "Testing macOS shell integration..."
        node -e "
          const ShellIntegrationManager = require('./src/platform/shell-integration');
          (async () => {
            const manager = new ShellIntegrationManager();
            await manager.initialize();
            const status = manager.getStatus();
            console.log('Detected shells on macOS:');
            status.detectedShells.forEach(shell => {
              console.log('  ' + shell.name + ': ' + (shell.available ? 'Available' : 'Not available'));
            });
          })().catch(console.error);
        "

    - name: Test macOS-specific paths
      run: |
        node -e "
          const pathHandler = require('./src/platform/path-handler').default;
          const paths = pathHandler.getConfigPaths();
          console.log('macOS config paths:');
          Object.entries(paths).forEach(([key, value]) => {
            console.log('  ' + key + ':', value);
          });
        "

    - name: Test macOS process management
      run: |
        node -e "
          const { ProcessManager } = require('./src/platform/process-manager');
          (async () => {
            const manager = new ProcessManager();
            await manager.initialize();
            console.log('macOS process manager initialized');
            
            // Test macOS-specific command
            const result = await manager.execute('uname -a');
            console.log('macOS system info result:', result.success);
          })().catch(console.error);
        "

    - name: Test macOS Application Support
      run: |
        node -e "
          const path = require('path');
          const os = require('os');
          const appSupport = path.join(os.homedir(), 'Library/Application Support');
          console.log('macOS Application Support path:', appSupport);
        "

  # Linux-specific testing
  test-linux:
    name: Linux Platform Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.target_platform == 'linux' || github.event.inputs.target_platform == 'all'
    
    strategy:
      matrix:
        container: [
          'ubuntu:20.04',
          'ubuntu:22.04',
          'debian:11',
          'centos:8',
          'alpine:latest'
        ]
    
    container: ${{ matrix.container }}
    
    steps:
    - name: Install basic tools
      run: |
        if command -v apt-get &> /dev/null; then
          apt-get update
          apt-get install -y curl git build-essential python3
        elif command -v yum &> /dev/null; then
          yum install -y curl git gcc-c++ make python3
        elif command -v apk &> /dev/null; then
          apk add --no-cache curl git build-base python3 npm nodejs
        fi

    - name: Install Node.js (non-Alpine)
      if: matrix.container != 'alpine:latest'
      run: |
        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
        apt-get install -y nodejs || yum install -y nodejs npm

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Linux Environment Setup
      run: |
        echo "Distribution: $(cat /etc/os-release | head -n1)"
        echo "Kernel: $(uname -r)"
        echo "Architecture: $(uname -m)"
        echo "Node.js: $(node --version || echo 'Not installed')"
        echo "NPM: $(npm --version || echo 'Not installed')"

    - name: Install NPM dependencies
      run: npm ci || npm install

    - name: Test Linux shell integration
      run: |
        echo "Testing Linux shell integration..."
        node -e "
          const ShellIntegrationManager = require('./src/platform/shell-integration');
          (async () => {
            const manager = new ShellIntegrationManager();
            await manager.initialize();
            const status = manager.getStatus();
            console.log('Detected shells on Linux:');
            status.detectedShells.forEach(shell => {
              console.log('  ' + shell.name + ': ' + (shell.available ? 'Available' : 'Not available'));
            });
          })().catch(console.error);
        "

    - name: Test Linux-specific paths
      run: |
        node -e "
          const pathHandler = require('./src/platform/path-handler').default;
          const paths = pathHandler.getConfigPaths();
          console.log('Linux config paths:');
          Object.entries(paths).forEach(([key, value]) => {
            console.log('  ' + key + ':', value);
          });
        "

    - name: Test systemd detection
      run: |
        node -e "
          console.log('Testing systemd detection...');
          const { exec } = require('child_process');
          const { promisify } = require('util');
          const execAsync = promisify(exec);
          
          (async () => {
            try {
              const result = await execAsync('ps -p 1 -o comm=');
              const init = result.stdout.trim();
              console.log('Init system:', init);
              console.log('Systemd detected:', init === 'systemd');
            } catch (error) {
              console.log('Init system detection failed');
            }
          })();
        "

    - name: Test Linux process management
      run: |
        node -e "
          const { ProcessManager } = require('./src/platform/process-manager');
          (async () => {
            const manager = new ProcessManager();
            await manager.initialize();
            console.log('Linux process manager initialized');
            
            // Test Linux-specific command
            const result = await manager.execute('ls -la /proc/version');
            console.log('Linux proc info result:', result.success);
          })().catch(console.error);
        "

  # Scaling tests
  scaling-tests:
    name: Agent Scaling Tests
    runs-on: ${{ matrix.os }}
    if: github.event.inputs.test_type == 'performance' || github.event.inputs.test_type == 'all'
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install dependencies
      run: npm ci

    - name: Test Queen Controller scaling
      run: |
        node -e "
          const { QueenController } = require('./src/platform/queen-controller');
          const os = require('os');
          
          (async () => {
            const agentCount = parseInt('${{ github.event.inputs.agent_count }}') || 100;
            console.log('Testing Queen Controller scaling with', agentCount, 'agents...');
            
            const controller = new QueenController({ 
              maxAgents: Math.min(agentCount, 1000) // Cap for CI
            });
            
            console.log('Platform:', process.platform);
            console.log('CPUs:', os.cpus().length);
            console.log('Memory:', Math.floor(os.totalmem() / 1024 / 1024), 'MB');
            
            // Test scaling calculations
            const systemLoad = os.loadavg();
            console.log('System load:', systemLoad);
            
            const memoryUsage = process.memoryUsage();
            console.log('Process memory:');
            console.log('  RSS:', Math.floor(memoryUsage.rss / 1024 / 1024), 'MB');
            console.log('  Heap Used:', Math.floor(memoryUsage.heapUsed / 1024 / 1024), 'MB');
            
            console.log('Queen Controller scaling test completed');
          })().catch(console.error);
        "

    - name: Memory stress test
      run: |
        node -e "
          console.log('Starting memory stress test...');
          const initialMemory = process.memoryUsage();
          
          // Simulate memory usage
          const arrays = [];
          for (let i = 0; i < 100; i++) {
            arrays.push(new Array(10000).fill('test-data-' + i));
          }
          
          const finalMemory = process.memoryUsage();
          
          console.log('Initial memory (MB):', Math.floor(initialMemory.heapUsed / 1024 / 1024));
          console.log('Final memory (MB):', Math.floor(finalMemory.heapUsed / 1024 / 1024));
          console.log('Memory increase (MB):', Math.floor((finalMemory.heapUsed - initialMemory.heapUsed) / 1024 / 1024));
          
          // Cleanup
          arrays.length = 0;
          global.gc && global.gc();
          
          console.log('Memory stress test completed');
        "

  # Integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'integration' || github.event.inputs.test_type == 'all'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install dependencies
      run: npm ci

    - name: Test complete system integration
      run: |
        node -e "
          const CrossPlatformTestSuite = require('./src/platform/test-suite');
          
          (async () => {
            console.log('Running complete system integration tests...');
            
            const testSuite = new CrossPlatformTestSuite({
              verbose: true,
              outputDir: './integration-test-results'
            });
            
            const results = await testSuite.runAllTests();
            
            console.log('Integration test results:');
            console.log('  Platform:', results.platform);
            console.log('  Total tests:', results.summary.total);
            console.log('  Passed:', results.summary.passed);
            console.log('  Failed:', results.summary.failed);
            console.log('  Coverage:', results.summary.coverage.toFixed(2) + '%');
            console.log('  Duration:', (results.duration / 1000).toFixed(2) + 's');
            
            if (!results.success) {
              console.error('Integration tests failed');
              process.exit(1);
            }
            
            console.log('All integration tests passed!');
          })().catch(err => {
            console.error('Integration test error:', err);
            process.exit(1);
          });
        "

    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: ./integration-test-results/
        retention-days: 7

  # Summary
  test-summary:
    name: Platform-Specific Test Summary
    runs-on: ubuntu-latest
    needs: [test-windows, test-macos, test-linux, scaling-tests, integration-tests]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "# Platform-Specific Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results by Platform" >> $GITHUB_STEP_SUMMARY
        echo "- Windows Tests: ${{ needs.test-windows.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- macOS Tests: ${{ needs.test-macos.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Linux Tests: ${{ needs.test-linux.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Scaling Tests: ${{ needs.scaling-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- Target Platform: ${{ github.event.inputs.target_platform }}" >> $GITHUB_STEP_SUMMARY
        echo "- Test Type: ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- Agent Count: ${{ github.event.inputs.agent_count }}" >> $GITHUB_STEP_SUMMARY