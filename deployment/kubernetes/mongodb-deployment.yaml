apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
  namespace: master-workflow
  labels:
    app: mongodb
    component: database
spec:
  type: ClusterIP
  clusterIP: None  # Headless service for StatefulSet
  ports:
  - port: 27017
    targetPort: 27017
    protocol: TCP
    name: mongodb
  selector:
    app: mongodb
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: master-workflow
  labels:
    app: mongodb
    component: database
spec:
  serviceName: mongodb-service
  replicas: 3  # MongoDB replica set with 3 nodes
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
        component: database
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 999  # MongoDB user
        fsGroup: 999

      affinity:
        # Spread MongoDB pods across different nodes
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - mongodb
              topologyKey: kubernetes.io/hostname

      terminationGracePeriodSeconds: 30

      initContainers:
      - name: init-mongodb
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          mkdir -p /data/db
          chmod -R 755 /data/db
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
        volumeMounts:
        - name: mongodb-data
          mountPath: /data/db

      containers:
      - name: mongodb
        image: mongo:6.0
        imagePullPolicy: IfNotPresent

        securityContext:
          runAsNonRoot: true
          runAsUser: 999
          readOnlyRootFilesystem: false  # MongoDB needs write access to /data
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

        ports:
        - containerPort: 27017
          name: mongodb
          protocol: TCP

        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: "root"
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: master-workflow-secrets
              key: MONGODB_ROOT_PASSWORD
        - name: MONGODB_USERNAME
          valueFrom:
            secretKeyRef:
              name: master-workflow-secrets
              key: MONGODB_USERNAME
        - name: MONGODB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: master-workflow-secrets
              key: MONGODB_PASSWORD
        - name: MONGODB_DATABASE
          value: "master-workflow"
        - name: MONGODB_REPLICA_SET
          value: "master-workflow-rs"

        command:
        - mongod
        - --config
        - /etc/mongodb/mongod.conf
        - --replSet
        - $(MONGODB_REPLICA_SET)

        volumeMounts:
        - name: mongodb-config
          mountPath: /etc/mongodb
        - name: mongodb-data
          mountPath: /data/db
        - name: mongodb-logs
          mountPath: /var/log/mongodb

        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
          limits:
            cpu: 4000m
            memory: 8Gi

        livenessProbe:
          exec:
            command:
            - mongo
            - --eval
            - "db.adminCommand('ping')"
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - mongo
            - --eval
            - "db.adminCommand('ping')"
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

      - name: mongodb-exporter
        image: percona/mongodb_exporter:0.39
        imagePullPolicy: IfNotPresent

        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

        ports:
        - containerPort: 9216
          name: metrics
          protocol: TCP

        env:
        - name: MONGODB_URI
          value: "mongodb://root:$(MONGODB_ROOT_PASSWORD)@localhost:27017"
        - name: MONGODB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: master-workflow-secrets
              key: MONGODB_ROOT_PASSWORD

        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

      volumes:
      - name: mongodb-config
        configMap:
          name: mongodb-config
      - name: mongodb-logs
        emptyDir: {}

  volumeClaimTemplates:
  - metadata:
      name: mongodb-data
      labels:
        app: mongodb
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi
---
# MongoDB Replica Set Initialization Job
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-replicaset-init
  namespace: master-workflow
spec:
  template:
    metadata:
      labels:
        app: mongodb-init
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        fsGroup: 999
      containers:
      - name: mongodb-init
        image: mongo:6.0
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
        env:
        - name: MONGODB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: master-workflow-secrets
              key: MONGODB_ROOT_PASSWORD
        - name: MONGODB_REPLICA_SET
          value: "master-workflow-rs"
        command:
        - sh
        - -c
        - |
          echo "Waiting for MongoDB pods to be ready..."
          sleep 60

          # Use environment variable for replica set name
          REPLICA_SET_NAME="${MONGODB_REPLICA_SET:-master-workflow-rs}"

          echo "Initializing MongoDB replica set: $REPLICA_SET_NAME..."
          mongo mongodb-0.mongodb-service.master-workflow.svc.cluster.local:27017 \
            --username root \
            --password $MONGODB_ROOT_PASSWORD \
            --authenticationDatabase admin \
            --eval '
              rs.initiate({
                _id: "'"$REPLICA_SET_NAME"'",
                members: [
                  { _id: 0, host: "mongodb-0.mongodb-service.master-workflow.svc.cluster.local:27017" },
                  { _id: 1, host: "mongodb-1.mongodb-service.master-workflow.svc.cluster.local:27017" },
                  { _id: 2, host: "mongodb-2.mongodb-service.master-workflow.svc.cluster.local:27017" }
                ]
              })
            '

          echo "Creating application user..."
          sleep 30
          mongo mongodb-0.mongodb-service.master-workflow.svc.cluster.local:27017/master-workflow \
            --username root \
            --password $MONGODB_ROOT_PASSWORD \
            --authenticationDatabase admin \
            --eval '
              db.createUser({
                user: "masterworkflow",
                pwd: "'$(cat /secrets/MONGODB_PASSWORD)'",
                roles: [
                  { role: "readWrite", db: "master-workflow" },
                  { role: "dbAdmin", db: "master-workflow" }
                ]
              })
            '

          echo "MongoDB replica set initialized successfully"
        volumeMounts:
        - name: secrets
          mountPath: /secrets
          readOnly: true
      volumes:
      - name: secrets
        secret:
          secretName: master-workflow-secrets
